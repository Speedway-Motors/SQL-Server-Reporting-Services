-- SMIHD-13068 - Open BOMs with Laser Shop Labor

/*
select * from tblSKU where ixSKU = '916108'
ixSKU	sDescription	        mPriceLevel1	mAverageCost
916108	SHOP LASER PER SECOND	0.03	        0.03
*/

SELECT
   BTM.ixFinishedSKU                         'SKU',
   ISNULL(S.sWebDescription, S.sDescription) 'SKU_Description',
   BTM.ixTransferNumber                      'Transfer_#',
   BTM.iQuantity                             'Qty_Requested',
   BTM.iCompletedQuantity                    'Qty_Completed',
   (BTM.iQuantity-isnull(BTM.iCompletedQuantity,0)) 'Qty_Remaining',
   FORMAT(D2.dtDate,'yyyy-MM-dd')             'BOM_Transfer_Create_Date',
   FORMAT(D.dtDate,'yyyy-MM-dd')             'Due_Date',
   isnull(MATSKU.Material_SKU,'No Material SKU') 'Material_SKU',
   MATSKU.Material_SKU_Description            'Material_SKU_Description',
   MATSKU.QtyPerBOM                          'Qty_Per_BOM',
   (CAST((BTM.iQuantity-isnull(BTM.iCompletedQuantity,0)) AS INT) * (MATSKU.QtyPerBOM)) AS 'Total_Units_Needed'
--into #LaserLaborMaterialSummary
from tblBOMTransferMaster BTM
   left join tblDate D on D.ixDate = BTM.ixDueDate
   left join tblDate D2 on D2.ixDate = BTM.ixCreateDate
   left join tblSKU S on BTM.ixFinishedSKU = S.ixSKU
   left join (select ixFinishedSKU, TD.ixSKU 'Material_SKU', ISNULL(S.sWebDescription, S.sDescription) 'Material_SKU_Description', iQuantity 'QtyPerBOM'
              from tblBOMTemplateDetail TD
                left join tblSKU S on TD.ixSKU = S.ixSKU
              where TD.ixSKU like 'M%') MATSKU on MATSKU.ixFinishedSKU = BTM.ixFinishedSKU
where --BTM.ixFinishedSKU = @SKU   
   BTM.ixFinishedSKU in (select distinct ixFinishedSKU
                        from tblBOMTemplateDetail
                        where ixSKU = '916108' -- 1,441
                        and flgDeletedFromSOP = 0
                        )
   and BTM.flgReverseBOM = 0
   and BTM.flgClosed = 0
   and BTM.dtCanceledDate is NULL
   and (ISNULL(BTM.iCompletedQuantity,0) < BTM.iQuantity 
                    OR iOpenQuantity > 0) 
ORDER BY Due_Date -- 141

/*
select distinct ixFinishedSKU
from tblBOMTemplateDetail
where ixSKU = '916108' -- 1,441
and flgDeletedFromSOP = 0

select * from tblBOMTemplateDetail where ixFinishedSKU = '350900.4.1-RH'

*/

/*************   SECOND SUMMARY REPORT!   ***********/
-- https://stackoverflow.com/questions/24278895/export-multiple-datasets-to-multiple-excel-sheets-in-ssrs

SELECT * FROM #LaserLaborMaterialSummary

SELECT Material_SKU, SUM(Total_Units_Needed) 'Total_Units_Needed'
FROM #LaserLaborMaterialSummary
WHERE Material_SKU IS NOT NULL
GROUP BY Material_SKU
ORDER BY SUM(Total_Units_Needed) DESC
/*          Total
Material    Units
SKU	        Needed
=========== ======
M4T0.16M01Q	57300
M4T0.09M02Q	56809
M2T0.18F01Q	52546
M2T0.14A01Q	49612
M2L0.25E01Q	27826
M4L0.25P01Q	17800
M4T0.06F01Q	15722
M4T0.09F01Q	12333
M4T0.13N01P	7840
M2T0.11A01Q	6141
M4T0.09M02P	5760
M4T0.19N01Q	5625
M2L0.38A01Q	5264
M4T0.13N01Q	1115
M2L0.75E01Q	840
M2T0.06H01Q	828
M2T0.12A04Q	778
M2L0.38E01Q	720
M4A3.00U02H	550
M4L0.38P04Q	515
M2F0.38J01N	500
M2L0.50E01Q	427
M3T0.14C01Q	112
M2T0.08F01Q	100
M3T0.04C01Q	60
M2L0.31E01Q	48
*/

DROP table #LaserLaborMaterialSummary




SELECT * FROM tblBOMTemplateDetail
where ixFinishedSKU in ( '94713222-5544','94713212-5544')

select distinct ixFinishedSKU
                        from tblBOMTemplateDetail
                        where ixSKU = '916108' -- 1,441
                        and flgDeletedFromSOP = 0

SELECT distinct ixFinishedSKU FROM tblBOMTemplateDetail
where ixFinishedSKU in ('1060000465','1060000552.03','1060001021-04','1060001157.01','1060001157.02','1060001157.03','1060001169','1060001178','1061001239','1061001244-01','1061001244-03','1061001264','1065230802','10652905623','106900639','106903310','106904357','106904571','106904909','106905101','106905767','106905773','106905916','10699000.01','10699000.02','10699000.03','10699000.04','10699000.05','10699000.06','10699000.07','10699000.08','10699000.09','10699000.10','10699000.12','10699000.13','10699000.14','10699000.15','10699000.16','10699000.17','10699000.18','10699000.19','10699000.20','10699000.21','10699000.23','10699000.24','10699000.25','10699000.26','10699000.27','10699000.31','10699000.32','10699000.33','10699000.34','10699000.35','10699000.37','10699000.38','10699000.39','10699000.40','10699001','10699002','10699003','10699004','10699006','10699007','10699008','10699009','10699010','10699011','10699012','10699013','10699014','10699015','10699016','10699017','10699018','10699019','10699019-1','10699019-2','10699020','10699020-1','10699020-2','10699021','10699021-1','10699021-2','10699022','10699024','10699025','10699026','10699027','10699028','106999175','106A700040008X','1115.001.1','1115.002.1','1115.009.1','1115.010V','1115.013.1','1115.014.1','1115.016','1115.017.1','1115.018.1','1115.020.1','1115.022.1','1115.025.1','1115.028.1','1115.028V','1115.029.1','1115.030.1','1115.032.1','1115.033.1','1115.034.1','1115.035.1','1115.036.1','1115.037.1','1115.038.1.1','1115.039.1','1115.044.1','1115.045.1','1115.046','1115.047','1115.048.1','1115.100.1','1115.101.1','1115.113.1','1115.133','1115.134','1115.135','1115.135V','1115.211.1','1115.213.1','1115.214.1','1115.215','1115.215.1','1115.215R','1115.216','1115.216.R','1115.217','1115.217.1','1115.218.1','1115.219','1115.400.1','1353272-1.1','1353272-1.2','1353273.1.1','1353273.1.2','1353274.1.1','1353274.1.2','1353294.L','1353294.R','1353298.1','1353298.2','1353312.1','1353764.1.1.1','1353764.1.1.2','1353764.2.1.1','1353764.2.1.2','1356023-2.1.1','1356023-2.1.2','1356852-1','1356852-3','3000002.1.1.1','300100006','3003600.1','3003600.2','3003600.3','3003600.4','3008101','3008102','3008103','3009015.1.1','350003.1.2','350003.1.3','350003.1.5','350003.1.6','350003.1.7.1','350003.1.8.1','350003.2.2','350003.3.2','350003.3.3','350003.3.4-LH','350003.3.4-RH','350003.3.5-LH','350003.3.5-RH','350003.3.6','350003.3.7.1','350003.3.7.2','350003.5.2','350004.1.1-LH','350004.1.1-RH','350004.1.3','350004.1.6','350004.1.7','350004.1.8','350004.1.9','350006.1-LH','350006.1-RH','350007.1','350007.2','350007.3','350009.2','350009.3','350009.4','350009.5','350009.6','350021.1.2','350021.1.3.1','350021.1.3.2','350021.2.1.2','350025-LH','350025-RH','350030.2','350030.3','350030.4','350030.5','350101.1.1','350101.1.2','3501100.1.1.1','3501100.1.1.15','3501100.1.1.3','3501100.1.1.4','3501100.1.1.5','3501100.1.1.6','3501100.1.10','3501100.1.11-L','3501100.1.11-R','3501100.1.9','3501105.1.1','3501105.1.2','3501105.1.3','3501105.1.7','3501105.2.1-LH','3501105.2.1-RH','3501105.2.2-LH','3501105.2.2-RH','3501105.2.3','350200.1.1','350202.1-L','350202.1-R','350206.1','350206.2','350400.1.1','350400.1.2-LH','350400.1.2-RH','350400.1.3-LH','350400.1.3-RH','350400.1.4-LH','350400.1.4-RH','350402.2','350410.1.1','350410.2.2','350410.2.3-L','350410.2.3-R','350410.2.4.1','350410.2.5.1','350410.2.6-L','350410.2.6-R','350500.1.1.4-LH','350500.1.1.4-RH','350500.1.1.5-LH','350500.1.1.5-RH','350500.1.1.6-LH','350500.1.1.6-RH','350500.1.1.7','350500.1.1.8','350500.1.1.9','350500.1.11','350500.1.12','350500.1.2.1','350500.1.2.2','350500.1.3.1','350500.1.3.2','350500.1.3.3','350500.1.3.4','350500.1.3.5','350500.1.4.1','350500.1.4.2-LH','350500.1.4.2-RH','350500.1.5','350500.1.6','350500.1.7.1-LH','350500.1.7.1-RH','350500.1.8','350500.1.9','350502.1','350502.2','350510.1.1.4-LH','350510.1.1.4-RH','350510.1.1.5-LH','350510.1.1.5-RH','350510.1.1.6-LH','350510.1.1.6-RH','350510.1.1.7','350510.1.7.1-LH','350510.1.7.1-RH','350512.1','350512.2','350602.3','350700.1.2.2','350700.1.3','350700.2.1.1','350700.2.1.2','350700.2.2-LH','350700.2.2-RH','350700.2.4-LH','350700.2.4-RH','350700.2.5.1','350700.2.5.2','350710.1.1.1-LH','350710.1.1.1-RH','350710.1.1.2','350710.1.2','350710.1.3','350710.1.4','350710.1.5','350710.1.6','350710.2.1.4','350710.2.2.1','350710.2.2.2','350710.3.1-LH','350710.3.1-RH','350710.3.3-LH','350710.3.3-RH','350710.4.2','350710.4.3','350710.4.4','350710.5.1-LH','350710.5.1-RH','350710.5.2-LH','350710.5.2-RH','350710.5.3','350710.7.1.1-LH','350710.7.1.1-RH','350710.7.1.2-LH','350710.7.1.2-RH','350710.7.1.3-LH','350710.7.1.3-RH','350710.7.1.4','350710.7.1.5','350710.7.2','350710.7.3.2','350710.7.3.3','350710.7.3.4','350710.7.3.5','350710.7.4','350800.2.1.1','350800.2.1.2','350800.2.2.1','350800.2.2.2','350810.1.1','350810.1.10-LH','350810.1.10-RH','350810.1.3-LH','350810.1.3-RH','350810.1.4-LH','350810.1.4-RH','350810.1.6.1','350810.1.6.2','350810.1.7','350810.2.1.3','350810.2.1.4','350810.2.1.5','350810.2.2','350900.2.1.2','350900.2.1.4','350900.2.11','350900.2.2.1','350900.2.2.2','350900.2.2.3','350900.2.3.1','350900.2.3.2','350900.2.4.1-LH','350900.2.4.1-RH','350900.2.4.2-LH','350900.2.4.2-RH','350900.2.5-LH','350900.2.5-RH','350900.2.6.1','350900.2.6.2','350900.2.7.2.1','350900.2.7.3.1','350900.2.7.4','350900.2.7.5','350900.2.8','350900.2.9.1-LH','350900.2.9.1-RH','350900.3.1.1-LH','350900.3.1.1-RH','350900.3.1.2-LH','350900.3.1.2-RH','350900.3.1.3-LH','350900.3.1.3-RH','350900.3.2.1','350900.3.2.2-LH','350900.3.2.2-RH','350900.3.3','350900.3.5.1','350900.3.5.2','350900.4.1-LH','350900.4.1-RH','350900.4.2-LH','350900.4.2-RH','350900.4.3-LH','350900.4.3-RH','350900.4.4-LH','350900.4.4-RH','350900.4.5','350901.1','350901.2','350902.1','350902.2','350904.1.4','363115','41811002.1','41811005-1','41811014.1','41811015.1','41811017.1','41811018.1','41811019.1','41811127.1','41811130.1','41811139.1','41811143.1','54564035.2.1','555006','555008','555009','555013','555015','555017','555018','555020','5802031.1','6273203.1.12','6273203.1.13','6273203.1.14.1','6273203.1.14.2','6273203.1.14.5','6273203.1.14.6','6273203.1.15.1','6273203.1.15.2','6273203.1.16.1','6273203.1.17.1','6273203.1.18.1','6273203.1.19','6273203.1.3.1','6273203.1.3.3','6273203.1.4.1','6273203.1.4.2','6273203.1.4.3','6273203.1.5.3','6273203.1.6.1','6273203.1.6.2','6273203.1.7.1','6273203.1.8.1','6273203.2.10.1','6273203.2.10.2','6273203.2.5.1','6273203.2.5.2','6273203.2.6','6273203.2.7','6273203.2.8.1','6273203.2.8.2','6273203.2.9.1','6273203.4.3','6273203.4.4','6273203.4.5','6273203.5.4','71501901.1','71501901.2','71501909.1','71501909.2','71501924.1','71501924.2','71501925','7151923.1','7151923.2','7151923.3','7151924','7151925','71520010.1','71520015','715205','715205SS','7152309.1-LH','7152309.1-RH','7152309.1.1','7152309.2.1','7152309.2.2-LH','7152309.2.2-RH','7152309.3-LH','7152309.3-RH','7152309.4.1','7152555','7153257','71533015.1','71533015.2','71533015.3','7154001.5','7154052','7154250.1.1','7154252.1.1','7154255.1.1','7154260.1.1','7154280-1','7154280-2','7154280.1','7154280.2','7154282-1.2','7154288','7154299','7154560028','715803','715BP15112','715BP15121.1','715DB206.1','715DB206SS','715F10351','7204125-1','7204136','7209313.1.2.1L','7209313.1.2.1R','7209313.1.2.2','7209313.1.2.3','9003270.16','9003270.17','91000026.LH','91000026.RH','91000027.LH','91000027.RH','91000028.1','91000029.LH','91000029.RH','91000030.1','91000031.LH','91000031.RH','9100081.1','910012815.1.1','91003102.14','91003102.15','91003102.20','91003102.21','91003540.1','91003540.15','91003540.16','91003540.17','91003540.18','91003540.2-L','91003540.2-R','91003540.3','91003540.4-L','91003540.4-R','91003540.5','91003540.6','91003540.7-L','91003540.7-R','91004754.1','91004754.11','91004754.13-L','91004754.13-R','91004754.14-L','91004754.14-R','91004754.5','91004754.6L','91004754.6R','91004754.7','91004754.8L','91004754.8R','9100537.2','9100551.3','9100553.2','91007119.1','91007120.1','91007142.1','91007145','91007146.1','91007147.1','91007211.1','91007211.2','9101203.05','9101203.075','9101203.1','9101203.15','9101203.2','9101204.05','9101204.075','9101204.1','9101204.15','9101204.2','9101205.05','9101205.075','9101205.1','9101205.15','9101205.2','9101206.05','9101206.075','9101206.1','9101206.15','9101206.2','9101207.05','9101207.075','9101207.1','9101207.15','9101207.2','91012339.1','91012528','91012901','9101300.1.1.1.1','9101300.1.1.1.2','91013002.1','91013605-1.75','91013605-2','91013830','91014754.1','91014754.2','91014754.3','91014754.4','91015770.1.1','91015770.1.2','91015770.1.4','91015770.2','91018030-2','91018031.1','91018042-2','9101963.1','9101964.1','9101977.1','9101978.1','91021900.1','91021900.3','91021900.5','91021951-RAW','91022555.2','91022555.3','91022664','91023664','91024754.1-L','91024754.1-R','91027001-1.1.1','91027001-1.1.2','91027001-1.1.3','91027001-1.1.4','91027001.2','9102802','91029012.1','91030084.1','91030088.1','91030088.2','910305.2','91031201.1','91031203.1','91031252.1.1','91031252.1.2','91031252.2','91031253.1.1','91031253.1.2','91031415.1','91032000.1.1','91032000.1.2','91032000.1.3-L','91032000.1.3-R','91032000.1.4','91032000.1.5','91032000.1.6','91032000.1.7','91032109.1','91032700.1','91032880','91032952.3','91032953.5','91034611','91035004.1.1-0','91035004.1.1-1','91035004.1.1-2','91035004.1.1-3','91035501.2.2','91035501.2.3','91035505.2-L','91035505.2-R','91035506.2.3','91035601.1.3','91035601.1.7','91035700.1.2-LH','91035700.1.2-RH','91035700.1.3-LH','91035700.1.3-RH','91035700.1.4-LH','91035700.1.4-RH','91035700.10','91035700.2.1','91035700.2.2','91035700.2.3','91035700.2.4','91035700.2.5','91035700.3.1','91035700.3.2','91035700.3.3','91035700.4.1-LH','91035700.4.1-RH','91035700.5','91035700.6','91035700.7','91035700.8-LH','91035700.8-RH','91035700.9','91035800.1.1-RH','91035800.1.1.1-LH','91035800.1.1.2-LH','91035800.1.2-LH','91035800.1.2-RH','91035801.1-LH','91035801.1-RH','9103610.1','91036400.1L','91036400.1R','91043540.25','91044030.1','91045005.1','91045555.7.1.1','91045555.8.1.1','910471-1.250','910471-1.375','91049935-1.1.2','91049935-1.1.3','91049935-1.1.L.1','91049935-1.1.R.1','91049935-1.2.1','91049935-1.3.1','91049935-1.6','91049942.1.1','91049942.1.2','91049942.1.3','91049942.1.4','91049942.1.5','91049942.2.1','91049942.2.2','91052820.2.1','91054018','91054022','91054024','91054026','91054028','91054032.1','91054222.1-LH','91054222.1-RH','91054222.2','91054222.3','91054222.4','91054223.1','91054223.2','91054223.3','91054223.4','91054223.5','91054233','91054234','91054236.1-LH','91054236.1-RH','91054236.2','91054237.1-LH','91054237.1-MID','91054237.1-RH','91054237.2','91054237.3','91054237.4','91054422.1','910544221.1','910544222.1','91054424.1','91054425.1','91054428.1','91054429.1','91054430.1','91054443.1','91054754.1-L','91054754.1-R','91056855-1','91058268.1','91063540.1','91063540.11','91063540.12','91063540.2','91063540.3','91063540.4','91063540.5-L','91063540.5-R','91064754.2-L','91064754.2-R','91064754.3','91073055.1','91073540.1','91073540.2','91073540.4','91073540.6','91073540.7','91074754.1','91074754.3','91075052.1','91076047E.1','91076047E.2','91081064.1','91081095.1.1','91081609.1','91082160','91082161','91082162','91082320-1.1.1','91082320-1.1.2.1','91082320-1.1.2.2','91082320-1.1.4.1','91082700-1.2','91082700-2.1.1','91084754.1','91089430.1.1','91089430.1.2','91089431.1.1','91093540.11','91093540.7','91096267.1','91139530.2','91140014.1','91140014.2','91140026.2','91140050','91140062.4','91140062.5','91140065.2','91140080.2','91140086.3','91140086.4','91140094','91140095','91140155.3','91140166','91140168.2','91140171','91140172','91140175.2','91140180.2','91140182','91140183.1','91140185.1','91140185.2','91140187','91140202','91140212.2','91140218.2','91140223','91140228.2','91140233.1.1','91140233.1.2','91140233.2','91140233.3','91140243.1','91140246.1','91140355','91140375.2','91140395.1','91140396.1','91140397.1','91140398.1','91140402.1','91140412','91140577.1','91140577.2','91140591.2','91140591.3','91140596.2','91140596.3','91140601.1','91140601.2','91140601.3','91140601.4','91140601.5','91140601.6','91140601.7','91140602','91140621.1','91140622.1','91140650.1','91140650.2','91140650.3','91140651.3','91332902.1','91332903.1','91381090.1','916031015.2','9161091.1.1','9161091.2.1','91612715.1.1','91612715.2.1','91615375','91616769.1.1.1-LH','91616769.1.1.1-RH','91616769.1.1.2','91616769.1.2','91616769.1.3','91616769.1.4','91616769.1.6','91616769.1.7','91616769.11.2','91616769.2.1.4','91616769.2.2.1','91616769.2.2.2','91616769.3.1-LH','91616769.3.1-RH','91616769.3.3-LH','91616769.3.3-RH','91616769.4.2','91616769.4.3','91616769.4.4','91616769.5.1-LH','91616769.5.1-RH','91616769.5.2-LH','91616769.5.2-RH','91616769.5.3','91616769.7.1.1-LH','91616769.7.1.1-RH','91616769.7.1.2-LH','91616769.7.1.2-RH','91616769.7.1.3-LH','91616769.7.1.3-RH','91616769.7.1.4','91616769.7.1.5','91616769.7.2','91616769.7.3.2','91616769.7.3.3','91616769.7.3.4','91616769.7.3.5','91616769.7.4','91616769.9.1','91616769.9.2','91616769.DRILL.1','91618009-DRV','91618009-PASS','91618012-2.1','91618013-2.1','91618015.2.1','91618015.2.2','91618015.2.3','91618059.1','91618059.2','91618956.1.1-L','91618956.1.1-R','91618957-1','91618959.1.1','91618960.1','91618960.2','9161940.1','9161940.2-LH','9161940.2-RH','91627001.1','9162831.1.1','9162831.1.2','9162831.2.1','91628901-1.1.1','91628902-2.1','91628904.4','91628907.1','91628908-1','91628910-4','91628910-5.1','91628910-7','91631800','91631901-1-ZINC','91631903-1.1','91631909-1.1','91631910-PLN.1.1','91631910-SS-1','91631912-1.1','91631913-1.1','91631915.4','91631915.5','91631916-1','91631944-1.1','91631944-1.2','91631944-2','91631990-L.1','91631991.1.1','91631991.2.1.1','91631992.1.1.1','91631992.1.1.2','91631992.2.1-L','91631992.2.1-R','91632002','91632003.1.1','91632003.1.2','91632004-1.1.1','91632011.1.1','91632019.1','91632040-1','91632040-2','91632043','91632044','91632061-1.1','91632061-2.1','91633012-1','91633013-1.1','91633013-1.2','91633015-1','91633018','91633019','91633041','91633044.1','91633046.3.1','91633046.4','91633047-1.7','91633048-1.1','91633048-2L','91633048-2R','91633049.1.1','91633050.3.1','91633050.3.2','91633054.1','91633057.1','91633057.2','91633057.3','91634309','91634312','91635007.1','91635008.1','91635010','91635011','91635012','91635013','91635050.3','91635052.1','91635060.1.1','91635100-1.1','91636038.1','91636038.2','91636038.3','91636038.4','91637030.1.4','91637040','91637068','91637074','91637103','91637105','91639108.21','91639108.22','91639108.24.1','91639108.31','91639108.32','91639110.21','91639110.22','91639110.31','91641001','91641002.1','91641006-1.1','91641006-1.1.1','91641009','91641011-1.1','91641025','91643502','91643504','91643510.1','91643510.2','91643511.1','91643512.1','91645009','91645010','91645011','91645025-1.1','91645025-1.1L','91645025-1.1R','91645050-1.1','91645050-1.2L','91645050-1.2R','91645050-1.3','91645052-1','91645100-1','91645100-2','91645105-1.1','91645105-1.2','91645106-1.1','91645106-1.2','91645112.1.3','91645310','91645311','91645490-1/2','91645490-3/4','91645490-5/8','91645491','91645502.1','91645512','91645513.1','91645513.2','91645533-1','91645535-1.1','91645545-3','91645554.1.1','91645554.1.3','91645554.1.4','91645556.1.1','91645557.1.1','91645557.1.2','91645557.1.3','91645559.1.1','91645559.1.2','9164754.1.1','91649022-1','91649022-2','91649023-1.2','91649023-1.3','91649023-1.4','91649023-4','91649023-5','91655571.1.1-LH','91655571.1.1-RH','91655571.1.2-LH','91655571.1.2-RH','91655571.2-LH','91655571.2-RH','91655572.1.2','91655572.2','91655801.11.1-L','91655801.11.1-R','91655801.8.1.2','91657013.1.1.LH','91657013.1.1.RH','91657013.1.2','91657013.2.LH','91657013.2.RH','91657014-1.1','91657014-1.2','91657014-1.3','91657014-1.4','91657016.1','91657025.1.L','91657025.1.R','91657025.2.L','91657025.2.R','91657025.3.2','91657025.3.3','91657026.1','91657027.1','91657028.1','91657034-3','91657034-4','91657055.1','91657056.1','91657057.1','91657104-1','91657104-2','91657104-3','91657104-4','91657104-4.LH','91657104-4.RH','91658100','9165823.1.1','91658250-1','91658250.1.1','91658251-1','91658253.1.1','9166072.1','9166072.2.1','9166072.3.1','9166072.3.2-LH','9166072.3.2-RH','9166072.4-LH','9166072.4-RH','91662067.11','91662067.12','91662067.13','91662067.13.RH','91662067.2','91662067.22','91662067.3','91662067.30-L','91662067.30-R','91662067.33','91662067.35','91662067.36','91662067.37','91662067.38','91662067.4','91662067.5','91662067.8','91662067.9','91662168.3','91662168.4','91662672.1','91662672.2','91664721.1.1','91666006-1','91666006-2','91667001.2','91667903-1','91668040.1.1','91668041.1.1','91668041.1.2','91668041.1.3','91668041.1.5','91668041.1.6','91668041.2.1','91668042.1','91668042.2','91668044.4','91668047.1','91668047.2','91668048.1','91668048.2','91668050.1.1','91668050.1.2','91668050.1.3','91668050.1.4','91668050.2','91673010-23','91673010-24','91673010-25','91673010-5-2','91673032-1','91674095.1.1','91674096.1.1','91674096.1.2','91676549.1','916776-R1.5-1.1','916776-R1.5-1.2','916776-R1.5-1.3','916778-R2.1.1','916778-R2.1.2','916778-R2.1.3','91680922.1','91682724.1.1.1','91699356.1','916C4000.1.1.1','916C4000.1.1.2','916C4004.1.1','916C4004.1.3','916C4004.1.4','91720155.1','91720155.2','91720155.3','91720249.1.1-L','91720249.1.1-R','91720381-1/2','91720381-3/4','91720381-5/8','91720382-1/2','91720382-3/4','91720382-5/8','91720402.1','91720402.2','91801221.1.1','91802854-2.1','91803226.1','93000013','93011013','93011016','93011021','93011138','9327000-1','9328001','940131','940137','940138','94020721','94036014.1','94517401.1','94517401.2','94517401.3','94517402','94536014','94536015','94612022','94612106','94612250','94612251','94612260','94612280','94612414','94612418','94612424','94612502','94612504','94612506','94612810','94612812','94612912','94614195','94614196','94614197.1','94614198.1','94614226','94614227','94617300','94617301','94617302','94617605','94617606','94622902','94713212-5544','94713222-5544','95612108','95612904','960003.3.1','96012680.2.1.1','960305360.1','960537.5','960537.6','96571000.1.2','96571000.1.3','96613016','96622000','96622034','96622204','96622238','96622242','96622402','96622404','96622902','96622904','96622921.1','96622922','96622927','96622932','96627400','96627506.1','96627506.2','96627506.3','96627506.4','96627506.6','96627508.1','96627508.2','96627508.3','96627508.4','96627508.5','96632010','97016027','97016028','97016029','97016030','97016031','97016032','97016033-LH','97016033-RH','97064015','97064019','97064020','97064022','97064027','9707106.1','9707106.2.1','9708006.1','9708315.1','97300000-1','97300000-2','97300000-3','97390100-1','97418932-1.1.1','97418932-1.1.2','97435200.1.1','97451932.1','97451932.2','97612010','97612235','97612900','97612950','97614016','97614017','97614018','97614019','97617400','97652932.1.1.1','97652932.1.1.2','97652932.3.1.1','97693100-1','9801000','9801010','9801020','9801021','980500-820','980500-830','980500-840','980500-850','980500-860','980510.1','98612200','98612202','98612208','98612209','98612300','98612302','98612304','98612306','98612308','98612310','98612312','98612314','98612316','98612400','98612402','98612500','98612502','98612700','98612702','98612703','98612706','98612900','98612901','98612902','98612904','98612905','98614018','98614900','98614901','98617400','98617402','98617404','98622202','98622204','98622206','98622220','98622224','98622226','98622227','98622228','98622229','98622230','98622232','98622234','98622236','98622238','98622240','98622250','98622252','98622254','98622256','98622262','98622263','98622264','98622265','98624050','98624051','98624052','98624053','98624054','98624055','98624072','98625056','98625065','98625070','98625071','98625072')
and ixFinishedSKU NOT IN (SELECT ixFinishedSKU from tblBOMTemplateDetail where ixSKU like 'M%')





SELECT Material_SKU, Material_SKU_Description, SUM(Total_Units_Needed) 'Total_Units_Needed'
FROM (SELECT
           BTM.ixFinishedSKU                         'SKU',
           ISNULL(S.sWebDescription, S.sDescription) 'SKU_Description',
           BTM.ixTransferNumber                      'Transfer_#',
           BTM.iQuantity                             'Qty_Requested',
           BTM.iCompletedQuantity                    'Qty_Completed',
           (BTM.iQuantity-isnull(BTM.iCompletedQuantity,0)) 'Qty_Remaining',
           FORMAT(D2.dtDate,'yyyy-MM-dd')             'BOM_Transfer_Create_Date',
           FORMAT(D.dtDate,'yyyy-MM-dd')             'Due_Date',
           isnull(MATSKU.Material_SKU,'No Material SKU') 'Material_SKU',
           MATSKU.Material_SKU_Description            'Material_SKU_Description',
            MATSKU.QtyPerBOM                          'Qty_Per_BOM',
            (CAST((BTM.iQuantity-isnull(BTM.iCompletedQuantity,0)) AS INT) * (MATSKU.QtyPerBOM)) AS 'Total_Units_Needed'
        from tblBOMTransferMaster BTM
           left join tblDate D on D.ixDate = BTM.ixDueDate
           left join tblDate D2 on D2.ixDate = BTM.ixCreateDate
           left join tblSKU S on BTM.ixFinishedSKU = S.ixSKU
           left join (select ixFinishedSKU, TD.ixSKU 'Material_SKU', ISNULL(S.sWebDescription, S.sDescription) 'Material_SKU_Description', iQuantity 'QtyPerBOM'
                      from tblBOMTemplateDetail TD
                        left join tblSKU S on TD.ixSKU = S.ixSKU
                      where TD.ixSKU like 'M%') MATSKU on MATSKU.ixFinishedSKU = BTM.ixFinishedSKU
        where BTM.ixFinishedSKU in (select distinct ixFinishedSKU
                                    from tblBOMTemplateDetail
                                    where ixSKU = '916108' -- 1,441
                                    and flgDeletedFromSOP = 0
                                    )
           and BTM.flgReverseBOM = 0
           and BTM.flgClosed = 0
           and BTM.dtCanceledDate is NULL
           and (ISNULL(BTM.iCompletedQuantity,0) < BTM.iQuantity 
                            OR iOpenQuantity > 0) 
        ) X
WHERE Material_SKU <> 'No Material SKU'
GROUP BY Material_SKU, Material_SKU_Description
ORDER BY SUM(Total_Units_Needed) DESC