-- SMIHD-19247 - SOP to DW feed issue with drop ship orders

-- example order with missing qty in tblDropship
select ixOrder,	ixDropship,	ixSpecialOrder,	iQty,	ixSKU,	sDescription, iOrdinality
 from tblDropship  
where ixOrder = '8539389'

select ixOrder,	iQuantity,	ixSKU, iOrdinality, flgLineStatus
 from tblOrderLine
where ixOrder = '8539389'


select ixOrder, count(distinct iOrdinality) 'OrdinCnt', max(iOrdinality)'MaxOrdin',
    max(iOrdinality) - count(distinct iOrdinality) 'Delta'
into #DupeOrdinality -- DROP TABLE #DupeOrdinality
from tblDropship
--where ixOrder = '6995091'
group by ixOrder
HAVING count(distinct iOrdinality) <> max(iOrdinality) -- 301 orders out of 222,151
order by 'Delta' desc                                  -- 61 more orders from 2021 as of 8/31/21

SELECT DO.ixOrder, dtOrderDate, dtShippedDate
from tblOrder O
    left join #DupeOrdinality DO on O.ixOrder = DO.ixOrder
WHERE DO.ixOrder is NOT NULL
order by dtOrderDate desc


select * from tblOrder
where ixOrder in ('8539389','8694587','9769813','8887273','8356182','8524372','8699584','8277215','8806089','8076389','8209181','8866681','8780286','8450275','8680682','8622983','8638780','8501178','8759183','8570670','8641680','8634743','7947435','6909294','9914419','7534633','7173609','8490531','9890533','9839756','9833025','8336379','7731951','9820936','9521254','9995826','7818056','9905702','6811890','8204014','9091042','9682079','9389078','8265135','7730477','6502287','9501316','6763875','7535017','6631046','9592453','7083867','5396649','4845739','9331351','9901737','7059587','8797403','9200454','9693013','7539487','7218608','7781889','9022957','6096741','9124220','9868418','8739581','6911387','9395912','9041864','9849430','6995091','9654252','9757931','9606050','7054592','9840856','8709744','8288897','8329303','9702066','7827202','8924265','8657377','8754934','9120968','8390435','7732739','9609465','7536697','9885555','9400430','9221950','7856154','7725612','8517492','9330164','9177459','8608297','8106888','6813576','9698658','9276408','7246799','7903588','8036447','7806569','8111367','8403799','9521975','7288387','9555155','7596070','7102063','7304897','9528005','4617428','6525472','8126697','9163450','8500940','9798169','9804642','6900372','7002567','8241981','9141226','6935093','7103915','6004999','7063557','7778293','7005462','9667556','9078447','6513675','9884103','7692230','6676299','7002563','9581057','7804301','8704027','4470567','9202639','8425626','8763506','8576130','8215863','8642483','6257569','7908071','9011978','9156258','7672693','9248138','6436288','7730188','9713837','8815925','9889211','9996843','9770741','9655344','8177945','6914176','7619763','7391477','7155217','9919001','6573389','9947743','8635942','7655637','9707316','9151738','9125310','7379368','6636886','7086963','8234719','6986196','8023164','4508705','8642194','7795279','9587932','9424022','9174662','9122741','7647425','6357767','7112209','8587999','6601470','7803182','9427340','7741128','7432190','6911552','8346699','8358268','7305156','7094888','7114593','7105721','6628143','9548247','7735573','4946823','7081064','7280360','7819356','7459768','8240437','8399875','7222040','6025063','9246829','6921090','5252068','8451055','9446522','9109122','8829236','6805859','9284747','9772664','9985041','6336663','8814025','9946615','6865974','6610247','9473546','9530732','9200144','7038140','9076331','9532533','8599886','9154763','7961563','8074253','9820826','9331455','7495715','7455260','9547906','8610983','8260294','8468293','8470528','6439865','9812917','6663788','7018834','7891155','7623925','8954433','6368862','9882066','9249636','9155133','8172902','7173389','7688929','8640825','8263475','7124961','6986193','9753845','9303358','6956094','9883229','7170207','8638628','9631523','8510550','9525136','7087046','7028471','7260465','6445973','9468646','9927643','9596524','9714748','9399665','9015022','8955578','9213313','6751152','8315261','8255670','9760517','7787398','7260099','9489533','6533364')
order by dtOrderDate desc


select ixOrder, count(*)
from tblDropship
group by ixOrder
having count(*) > 1
order by count(*) desc

select ixOrder, ixDropship, ixSpecialOrder, ixSKU, iQty, iOrdinality 
from tblDropship 
where ixOrder = '8587985'

