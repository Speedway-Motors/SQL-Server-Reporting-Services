-- SMIHD-19407 - days between customer orders
 select
    o.*
    , datediff(day,o.FirstOrderDate,o.NextOrderDate) as DaysUntilSecondOrder
into #DaysUntil2ndOrder -- DROP TABLE #DaysUntil2ndOrder
from
(
    select
    --top 40000
        ixCustomer,
        min(dtOrderDate) over (partition by ixCustomer order by dtOrderDate) as FirstOrderDate
        , lead(dtOrderDate) over (partition by ixCustomer order by dtOrderDate) as NextOrderDate
    from
        tblOrder o
    where ixOrderDate >= 19207
        and sOrderStatus = 'Shipped'
        and ixOrder NOT LIKE '%-%'
     --   where o.ixCustomer in ('201948','752757','1579123','1636200','1718721','1751189','2240653','2539477','2924138','2950439','3004005','3014953','3025824','3028951','3033957','3036854','3037657','3037858','3043851','3044855','3045955','3051756','3053851','3056950','3058853','3059658','3059659','3062958','3063954','3066959','3068657','3071656','3075654','3100952','3102551','3108058','3110957','3111056','3112352','3124353','3132650','3134350','3136852','3141855','3144952','3149156','3151150','3151153','3153450','3154455','3156955','3157955','3160141','3161550','3163352','3163553','3165351','3167250','3168556','3169159','3169359','3173154','3178158','3178557','3179351','3179752','3180357','3180758','3182158','3187758','3188451','3188852','3190350','3192454','3195359','3210057','3211057','3216056','3221052','3222052','3262256','3263259','3267151','3272055','3277055','3278057','3278159','3280354','3281054','3283052','3286150','3294152','3472634','3673302','3809436','3982447')

) o
--where NextOrderDate is NOT NULL
order by ixCustomer, 


SELECT * FROM #DaysUntil2ndOrder
where ixCustomer in ('201948','752757','1579123','1636200','1718721','1751189','2240653','2539477','2924138','2950439','3004005','3014953','3025824','3028951','3033957','3036854','3037657','3037858','3043851','3044855','3045955','3051756','3053851','3056950','3058853','3059658','3059659','3062958','3063954','3066959','3068657','3071656','3075654','3100952','3102551','3108058','3110957','3111056','3112352','3124353','3132650','3134350','3136852','3141855','3144952','3149156','3151150','3151153','3153450','3154455','3156955','3157955','3160141','3161550','3163352','3163553','3165351','3167250','3168556','3169159','3169359','3173154','3178158','3178557','3179351','3179752','3180357','3180758','3182158','3187758','3188451','3188852','3190350','3192454','3195359','3210057','3211057','3216056','3221052','3222052','3262256','3263259','3267151','3272055','3277055','3278057','3278159','3280354','3281054','3283052','3286150','3294152','3472634','3673302','3809436','3982447')-- 96 customers
and DaysUntilSecondOrder is NOT NULL
order by ixCustomer, DaysUntilSecondOrder

